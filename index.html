<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Isaahi App Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --bg-secondary: #f2f2f7;
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --accent: #007aff;
            --danger: #ff3b30;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        #main-view { height: 100%; overflow-y: auto; padding-bottom: calc(90px + var(--safe-bottom)); scroll-behavior: smooth; }
        .header { position: sticky; top: 0; z-index: 40; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        .tab-bar { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding-bottom: var(--safe-bottom); z-index: 50; }
        .tab-item { padding: 10px; display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--text-secondary); cursor: pointer; }
        .tab-item.active { color: var(--accent); }
        .app-card { background: white; border-radius: 18px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .app-icon { width: 60px; height: 60px; border-radius: 14px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
        .view-layer { position: fixed; inset: 0; background: white; z-index: 100; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        .view-layer.open { transform: translateY(0); }
        #app-runner { position: fixed; inset: 0; background: black; z-index: 1000; display: none; flex-direction: column; }
        #app-runner iframe { flex: 1; border: none; background: white; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; width: 90%; max-width: 400px; border-radius: 28px; padding: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        input, textarea, select { width: 100%; padding: 12px; border-radius: 12px; background: #f2f2f7; border: none; font-size: 16px; margin-bottom: 8px; outline-color: var(--accent); }
        .btn-primary { width: 100%; padding: 14px; border-radius: 14px; font-weight: 700; transition: opacity 0.2s; }
        .btn-primary:active { opacity: 0.7; }
        
        .external-link-badge { font-size: 9px; font-weight: 800; background: rgba(0,0,0,0.05); color: #666; padding: 2px 6px; border-radius: 6px; display: inline-flex; align-items: center; gap: 3px; margin-top: 4px; border: 0.5px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="loading-screen" class="loading-overlay">
    <div class="spinner"></div>
    <p class="mt-4 text-gray-500 font-medium text-sm tracking-wide">CONNECTING TO ISAAHI</p>
</div>

<div id="app-container">
    <div id="main-view"></div>
    <nav class="tab-bar">
        <div class="tab-item active" onclick="router('today')"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>Today</div>
        <div class="tab-item" onclick="router('apps')"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 10h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 16h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4z"/></svg>Apps</div>
        <div class="tab-item" onclick="router('publish')"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>Publish</div>
        <div class="tab-item" onclick="router('search')"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>Search</div>
    </nav>
</div>

<div id="detail-view" class="view-layer">
    <div class="p-5 flex flex-col h-full overflow-y-auto">
        <button onclick="closeDetail()" class="text-blue-500 font-bold flex items-center mb-4"><svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg> Back</button>
        <div id="detail-content"></div>
    </div>
</div>

<div id="app-runner">
    <div class="bg-gray-900 text-white p-3 flex justify-between items-center">
        <span id="runner-title" class="font-bold truncate max-w-[200px]">App</span>
        <button onclick="closeAppRunner()" class="bg-red-500 px-4 py-1 rounded-full text-xs font-bold uppercase">Close</button>
    </div>
    <iframe id="runner-frame"></iframe>
</div>

<div id="modal-overlay" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" id="modal-content"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'isaahi-store';

    let user = null;
    let apps = [];
    let currentApp = null;
    let uploadedFile = null;

    // --- Global Logic ---
    async function init() {
        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (token) await signInWithCustomToken(auth, token);
        else await signInAnonymously(auth);

        onAuthStateChanged(auth, (u) => {
            user = u;
            document.getElementById('loading-screen').style.display = 'none';
            ensureDefaultStoreApp();
            router('today');
        });

        const appsRef = collection(db, 'artifacts', appId, 'public', 'data', 'apps');
        onSnapshot(appsRef, (snap) => {
            apps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            apps.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            renderCurrentView();
        });
    }

    async function ensureDefaultStoreApp() {
        const storeUrl = "https://raahialt1-png.github.io/Isaahi-AppStore/";
        const appsRef = collection(db, 'artifacts', appId, 'public', 'data', 'apps');
        const q = await getDocs(appsRef);
        const found = q.docs.some(d => d.data().appUrl === storeUrl);
        if (!found) {
            await addDoc(appsRef, {
                name: "Isaahi App Store",
                developerName: "raahialt1-png",
                description: "The official web portal for the Isaahi App ecosystem.",
                appUrl: storeUrl,
                icon: "ðŸ¬",
                color: "bg-blue-600",
                ownerId: "system",
                createdAt: serverTimestamp()
            });
        }
    }

    window.router = (view) => {
        window.currentView = view;
        renderCurrentView();
    }

    function renderCurrentView() {
        const view = window.currentView || 'today';
        const main = document.getElementById('main-view');
        document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
        const tab = document.querySelector(`.tab-item[onclick*="${view}"]`);
        if(tab) tab.classList.add('active');
        
        const profileInitials = user && !user.isAnonymous ? "OK" : "IA";
        const profileIcon = `<div onclick="openAccount()" class="w-8 h-8 rounded-full ${user && !user.isAnonymous ? 'bg-blue-600' : 'bg-gray-200 text-gray-400'} text-white flex items-center justify-center text-[10px] font-black cursor-pointer transition-transform active:scale-90 shadow-sm">${profileInitials}</div>`;

        if (view === 'today') {
            const hero = apps[0];
            main.innerHTML = `
                <div class="header"><h1>Isaahi</h1>${profileIcon}</div>
                <div class="p-5">
                    ${hero ? `
                    <div class="app-card relative h-96 cursor-pointer shadow-xl overflow-hidden" onclick="openDetail('${hero.id}')">
                        <div class="absolute inset-0 ${hero.color || 'bg-blue-500'} opacity-90"></div>
                        <div class="absolute bottom-0 left-0 right-0 p-6 text-white bg-gradient-to-t from-black/80 to-transparent">
                            <span class="text-[10px] font-black uppercase tracking-widest opacity-70">Featured App</span>
                            <h2 class="text-3xl font-extrabold my-1">${hero.name}</h2>
                            <p class="text-sm opacity-90 line-clamp-2">${hero.description}</p>
                            ${hero.appUrl.startsWith('http') ? `<div class="mt-3 text-[10px] bg-white/20 px-2 py-1 rounded inline-flex items-center gap-1 font-bold"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg> ${new URL(hero.appUrl).hostname}</div>` : ''}
                        </div>
                    </div>` : '<p class="text-center py-20 text-gray-400">Loading apps...</p>'}
                    <h2 class="mt-8 mb-4">Discover More</h2>
                    ${apps.slice(1, 20).map(a => renderListItem(a)).join('')}
                </div>`;
        } else if (view === 'apps') {
            main.innerHTML = `<div class="header"><h1>Apps</h1>${profileIcon}</div><div class="p-5">${apps.map(a => renderListItem(a)).join('')}</div>`;
        } else if (view === 'publish') {
            if (!user || user.isAnonymous) {
                main.innerHTML = `<div class="header"><h1>Publish</h1>${profileIcon}</div><div class="p-10 text-center"><h2>Join the Store</h2><p class="text-gray-500 mb-6">Create an account to publish and manage your apps.</p><button onclick="openAuth()" class="btn-primary bg-blue-600 text-white">Log In / Sign Up</button></div>`;
                return;
            }
            main.innerHTML = `
                <div class="header"><h1>Publish</h1>${profileIcon}</div>
                <div class="p-5">
                    <form id="publish-form" class="space-y-4">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">App Name</label><input id="p-name" required placeholder="Super App"></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">File Upload (.html)</label>
                            <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center bg-gray-50 relative">
                                <span id="file-status" class="text-xs text-gray-400">Tap to select HTML file</span>
                                <input type="file" id="p-file" accept=".html" class="absolute inset-0 opacity-0 cursor-pointer">
                            </div>
                        </div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">External Link (Optional)</label><input id="p-url" placeholder="https://..."></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Description</label><textarea id="p-desc" required rows="3" placeholder="Description..."></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Icon (Emoji)</label><input id="p-icon" value="ðŸš€"></div>
                            <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Brand Color</label>
                                <select id="p-color">
                                    <option value="bg-blue-600">Blue</option><option value="bg-red-500">Red</option>
                                    <option value="bg-green-500">Green</option><option value="bg-purple-600">Purple</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary bg-blue-600 text-white mt-6 shadow-lg shadow-blue-200">Publish to Isaahi</button>
                    </form>
                </div>`;
            setupPublishForm();
        } else if (view === 'search') {
            main.innerHTML = `<div class="header"><h1>Search</h1>${profileIcon}</div><div class="p-5"><input id="search-input" placeholder="Search apps..." class="mb-6"><div id="results"></div></div>`;
            document.getElementById('search-input').oninput = (e) => {
                const q = e.target.value.toLowerCase();
                const res = apps.filter(a => a.name.toLowerCase().includes(q));
                document.getElementById('results').innerHTML = res.map(a => renderListItem(a)).join('');
            };
        }
    }

    function renderListItem(a) {
        let domainLabel = "";
        if (a.appUrl && a.appUrl.startsWith('http')) {
            try {
                const url = new URL(a.appUrl);
                domainLabel = `<div class="external-link-badge"><svg class="w-2 h-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg> ${url.hostname}</div>`;
            } catch(e) {}
        }

        return `<div class="flex items-center gap-4 py-3 border-b border-gray-100" onclick="openDetail('${a.id}')">
            <div class="app-icon sm ${a.color || 'bg-blue-600'}">${a.icon || 'ðŸš€'}</div>
            <div class="flex-1 min-w-0">
                <h3 class="text-gray-900 font-bold truncate leading-tight">${a.name}</h3>
                <p class="text-[11px] text-gray-400 truncate">${a.developerName || 'Unknown'}</p>
                ${domainLabel}
            </div>
            <button class="bg-gray-100 text-blue-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-tight active:scale-95" onclick="event.stopPropagation(); openGetModal('${a.id}')">GET</button>
        </div>`;
    }

    window.openDetail = (id) => {
        const app = apps.find(a => a.id === id);
        currentApp = app;
        const isOwner = user && app.ownerId === user.uid;
        document.getElementById('detail-content').innerHTML = `
            <div class="flex gap-5 items-end mb-6">
                <div class="app-icon lg ${app.color}">${app.icon}</div>
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-black">${app.name}</h2>
                    <p class="text-gray-400 font-medium">${app.developerName}</p>
                    <button class="bg-blue-600 text-white px-8 py-1.5 rounded-full text-sm font-bold mt-2 shadow-lg shadow-blue-100" onclick="openGetModal('${app.id}')">GET</button>
                </div>
            </div>
            <div class="flex border-y border-gray-100 py-4 mb-6 justify-around text-center">
                <div><p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Store Rank</p><p class="text-xl font-bold text-gray-700">#${Math.floor(Math.random()*20)+1}</p></div>
                <div><p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Age</p><p class="text-xl font-bold text-gray-700">4+</p></div>
                <div><p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">Version</p><p class="text-xl font-bold text-gray-700">1.0</p></div>
            </div>
            <h3 class="text-lg font-bold">About</h3>
            <p class="text-gray-600 mt-2 leading-relaxed whitespace-pre-wrap text-sm mb-10">${app.description}</p>
            ${isOwner ? `<button id="del-btn" class="btn-primary bg-red-500 text-white mt-10">Remove My App</button>` : ''}
        `;
        if (isOwner) document.getElementById('del-btn').onclick = () => deleteApp(app.id);
        document.getElementById('detail-view').classList.add('open');
    }

    window.closeDetail = () => document.getElementById('detail-view').classList.remove('open');

    async function deleteApp(id) {
        if (!confirm("Remove this app permanently?")) return;
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'apps', id));
        closeDetail();
    }

    window.openGetModal = (id) => {
        currentApp = apps.find(a => a.id === id);
        const modal = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        
        let externalHint = "";
        if (currentApp.appUrl.startsWith('http')) {
            externalHint = `<div class="mt-4 p-3 bg-gray-50 rounded-xl text-left border border-gray-100">
                <p class="text-[11px] text-gray-500 leading-normal"><b>Note:</b> This is an external web app. You can launch it now or save it to your home screen via the browser menu.</p>
            </div>`;
        }

        content.innerHTML = `
            <h2 class="text-xl font-black">Get ${currentApp.name}</h2>
            <div class="mt-6 space-y-3">
                <button onclick="downloadApp('win')" class="btn-primary bg-blue-600 text-white">Download Windows Shortcut</button>
                <button onclick="downloadApp('mac')" class="btn-primary bg-blue-600 text-white">Download Mac Shortcut</button>
                <button onclick="runApp()" class="btn-primary bg-gray-100 !text-gray-900 font-black">Launch Instantly</button>
                ${externalHint}
            </div>
        `;
        modal.style.display = 'flex';
    }

    window.downloadApp = (platform) => {
        const url = currentApp.appUrl;
        if (url.startsWith('data:')) {
            const a = document.createElement('a'); a.href = url; a.download = currentApp.name + ".html"; a.click();
        } else {
            const ext = platform === 'win' ? '.url' : '.webloc';
            const content = platform === 'win' ? `[InternetShortcut]\nURL=${url}` : `<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>URL</key><string>${url}</string></dict></plist>`;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content])); a.download = currentApp.name + ext; a.click();
        }
        document.getElementById('modal-overlay').style.display = 'none';
    }

    window.runApp = () => {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('runner-title').innerText = currentApp.name;
        document.getElementById('runner-frame').src = currentApp.appUrl;
        document.getElementById('app-runner').style.display = 'flex';
    }

    window.closeAppRunner = () => {
        document.getElementById('runner-frame').src = "";
        document.getElementById('app-runner').style.display = 'none';
    }

    window.openAccount = () => {
        if (!user || user.isAnonymous) return openAuth();
        openProfile();
    }

    window.openAuth = () => {
        const modal = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        content.innerHTML = `
            <div id="auth-box">
                <h2 class="text-2xl font-black">Developer ID</h2>
                <p class="text-gray-400 mb-6 text-sm">Log in to manage your Isaahi profile.</p>
                <input id="auth-email" type="email" placeholder="Email address">
                <input id="auth-pass" type="password" placeholder="Password">
                <button id="auth-btn" class="btn-primary bg-blue-600 text-white mt-2">Sign In</button>
                <button onclick="toggleAuthMode(this)" class="w-full text-blue-600 text-xs mt-4 font-bold">Create a new account</button>
            </div>
        `;
        document.getElementById('auth-btn').onclick = () => handleAuthAction('login');
        modal.style.display = 'flex';
    }

    window.toggleAuthMode = (btn) => {
        const h2 = btn.parentElement.querySelector('h2');
        const actionBtn = document.getElementById('auth-btn');
        if (h2.innerText === 'Developer ID') {
            h2.innerText = 'Join Isaahi';
            const nameInput = document.createElement('input');
            nameInput.id = 'auth-name';
            nameInput.placeholder = 'Public Name';
            btn.parentElement.insertBefore(nameInput, document.getElementById('auth-email'));
            actionBtn.innerText = 'Sign Up';
            actionBtn.onclick = () => handleAuthAction('signup');
            btn.innerText = 'Back to Log In';
        } else {
            h2.innerText = 'Developer ID';
            document.getElementById('auth-name')?.remove();
            actionBtn.innerText = 'Sign In';
            actionBtn.onclick = () => handleAuthAction('login');
            btn.innerText = "Create a new account";
        }
    }

    async function handleAuthAction(mode) {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
            if (mode === 'signup') {
                const name = document.getElementById('auth-name').value;
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile', 'data'), { name, email });
            } else {
                await signInWithEmailAndPassword(auth, email, pass);
            }
            document.getElementById('modal-overlay').style.display = 'none';
        } catch (e) { alert(e.message); }
    }

    window.openProfile = async () => {
        const pDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
        const profile = pDoc.data();
        const modal = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        content.innerHTML = `
            <div class="text-center">
                <div class="w-20 h-20 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl font-bold">${profile?.name?.[0] || 'U'}</div>
                <h2 class="text-xl font-black">${profile?.name || 'Developer'}</h2>
                <p class="text-gray-400 text-sm mb-8">${user.email}</p>
                <button id="logout-btn" class="btn-primary bg-red-500 text-white">Log Out</button>
            </div>
        `;
        document.getElementById('logout-btn').onclick = handleLogout;
        modal.style.display = 'flex';
    }

    window.handleLogout = async () => {
        await signOut(auth);
        document.getElementById('modal-overlay').style.display = 'none';
        router('today');
    }

    function setupPublishForm() {
        const fileIn = document.getElementById('p-file');
        fileIn.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                uploadedFile = ev.target.result;
                document.getElementById('file-status').innerText = file.name;
                document.getElementById('file-status').classList.add('text-blue-600', 'font-bold');
            };
            reader.readAsDataURL(file);
        };

        document.getElementById('publish-form').onsubmit = async (e) => {
            e.preventDefault();
            const pDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
            const pData = pDoc.data();
            
            const appData = {
                name: document.getElementById('p-name').value,
                description: document.getElementById('p-desc').value,
                appUrl: uploadedFile || document.getElementById('p-url').value,
                icon: document.getElementById('p-icon').value,
                color: document.getElementById('p-color').value,
                developerName: pData?.name || 'Isaahi Dev',
                ownerId: user.uid,
                createdAt: serverTimestamp()
            };

            if (!appData.appUrl) return alert("Select a file or provide a link.");
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Publishing...";
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'apps'), appData);
            uploadedFile = null;
            router('today');
        };
    }

    init();
</script>
</body>
</html>
